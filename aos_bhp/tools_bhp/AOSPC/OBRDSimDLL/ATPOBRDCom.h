#pragma once
/*******************************************************************************
*
* (C) COPYRIGHT Bombardier Transportation (Signal) Sweden AB, 2018
*
* We reserve all rights in this file and in the information
* contained therein. Reproduction, use or disclosure to third
* parties without written authority is strictly forbidden.
*
*  %name:          ATPOBRDCom.h %
*
*  %version:       7 %
*
*  %created_by:    marlundg %
*
*  %date_created:  2018-10-22 18:40 %
*
*  DESCRIPTION: OBRD Protocol Layers according to FFFIS AOS-OBRD
*
******************************************************************************/

/*******************************************************************************
*
* REVISION HISTORY :
*
* Date          Name        Changes
* ---------------------------------------------------------------------------
* 2018-10-22    Marlundg    File created
*
*******************************************************************************/
#include <time.h>
#include "OBRDSimTypes.h"

// NTOh/HTON for 64-bit values
#define HTONLL(x) ((1==htonl(1)) ? (x) : (((unsigned long long)htonl((x) & 0xFFFFFFFFUL)) << 32) | htonl((unsigned long)((x) >> 32)))
#define NTOHLL(x) ((1==ntohl(1)) ? (x) : (((unsigned long long)ntohl((x) & 0xFFFFFFFFUL)) << 32) | ntohl((unsigned long)((x) >> 32)))

using namespace System;
using namespace System::ComponentModel;
using namespace System::Collections;
using namespace System::Data;
using namespace System::Net;
using namespace System::Net::Sockets;
using namespace System::Text;
using namespace System::IO;

namespace OBRDSimDLL {
  


  public ref class ATPOBRDCom
  {
  public:

    ATPOBRDCom(
      IPAddress^ ip,
      unsigned short port,
      unsigned short mdlSiteId,
      String^ mdlReceiverId,
      String^ mdlSenderId,
      unsigned short mdlLocoId);

    void UpdateSafetyParams(unsigned short siteId, String^ receiverId, String^ senderId, unsigned short locoId);

    void Connect();
    void Disconnect();
    bool Connected();
    
    bool SendProtocolVersion(Byte majorVersion, Byte minorVersion, bool injectCRCError);
    bool SendStatusReport(posItem rearPosition, Byte lastCarBrakePressure, bool injectCRCError);
    
    bool ReceiveProtocolVersion(Byte &majorVersion, Byte &minorVersion);
    bool ReceiveRejection(Byte &reason, Byte &majorVersion, Byte &minorVersion);
    bool ReceiveData(unsigned short &receivedRnid);

  private:

    unsigned long long CalculateCRC64(array<Byte>^ data, UInt16 startIndex, UInt16 dataSize);
    bool InterpretApplicationData(array<Byte>^ buffer, unsigned short &interpretedlength, unsigned short &receivedRnid);
    bool SendData(array<Byte>^ data, bool injectCRCError);
    void ClearData(void);

    // AOS communication
    IPAddress^          aosIp;
    unsigned short int  aosObrdPort;
    Socket^             atpObrdSocket;

    // Safety Parameters
    unsigned short siteId;
    String^ receiverId;
    String^ senderId;
    unsigned short locoId;

    // Latest received Data
    unsigned short rnidPacket;
    unsigned short rlPacket;
    Byte rqRejection;
    Byte rmPrprotocolVersionMinor;
    Byte rmPrprotocolVersionMajor;
  };

  // Protocol constants
  static const unsigned char STX = 0x02;
  static const UInt64 CRC_INIT_VAL = 0x989626B1E8F2D6F0;

  static const UInt64 crcTable[256] =
  {
    0x0000000000000000UL,0x843EED14D357E50DUL,
    0x8C43373D75F82F17UL,0x087DDA29A6AFCA1AUL,
    0x9CB8836E38A7BB23UL,0x18866E7AEBF05E2EUL,
    0x10FBB4534D5F9434UL,0x94C559479E087139UL,
    0xBD4FEBC8A218934BUL,0x397106DC714F7646UL,
    0x310CDCF5D7E0BC5CUL,0xB53231E104B75951UL,
    0x21F768A69ABF2868UL,0xA5C985B249E8CD65UL,
    0xADB45F9BEF47077FUL,0x298AB28F3C10E272UL,
    0xFEA13A859766C39BUL,0x7A9FD79144312696UL,
    0x72E20DB8E29EEC8CUL,0xF6DCE0AC31C90981UL,
    0x6219B9EBAFC178B8UL,0xE62754FF7C969DB5UL,
    0xEE5A8ED6DA3957AFUL,0x6A6463C2096EB2A2UL,
    0x43EED14D357E50D0UL,0xC7D03C59E629B5DDUL,
    0xCFADE67040867FC7UL,0x4B930B6493D19ACAUL,
    0xDF5652230DD9EBF3UL,0x5B68BF37DE8E0EFEUL,
    0x5315651E7821C4E4UL,0xD72B880AAB7621E9UL,
    0x797C981FFD9A623BUL,0xFD42750B2ECD8736UL,
    0xF53FAF2288624D2CUL,0x710142365B35A821UL,
    0xE5C41B71C53DD918UL,0x61FAF665166A3C15UL,
    0x69872C4CB0C5F60FUL,0xEDB9C15863921302UL,
    0xC43373D75F82F170UL,0x400D9EC38CD5147DUL,
    0x487044EA2A7ADE67UL,0xCC4EA9FEF92D3B6AUL,
    0x588BF0B967254A53UL,0xDCB51DADB472AF5EUL,
    0xD4C8C78412DD6544UL,0x50F62A90C18A8049UL,
    0x87DDA29A6AFCA1A0UL,0x03E34F8EB9AB44ADUL,
    0x0B9E95A71F048EB7UL,0x8FA078B3CC536BBAUL,
    0x1B6521F4525B1A83UL,0x9F5BCCE0810CFF8EUL,
    0x972616C927A33594UL,0x1318FBDDF4F4D099UL,
    0x3A924952C8E432EBUL,0xBEACA4461BB3D7E6UL,
    0xB6D17E6FBD1C1DFCUL,0x32EF937B6E4BF8F1UL,
    0xA62ACA3CF04389C8UL,0x2214272823146CC5UL,
    0x2A69FD0185BBA6DFUL,0xAE57101556EC43D2UL,
    0xF2F9303FFB34C476UL,0x76C7DD2B2863217BUL,
    0x7EBA07028ECCEB61UL,0xFA84EA165D9B0E6CUL,
    0x6E41B351C3937F55UL,0xEA7F5E4510C49A58UL,
    0xE202846CB66B5042UL,0x663C6978653CB54FUL,
    0x4FB6DBF7592C573DUL,0xCB8836E38A7BB230UL,
    0xC3F5ECCA2CD4782AUL,0x47CB01DEFF839D27UL,
    0xD30E5899618BEC1EUL,0x5730B58DB2DC0913UL,
    0x5F4D6FA41473C309UL,0xDB7382B0C7242604UL,
    0x0C580ABA6C5207EDUL,0x8866E7AEBF05E2E0UL,
    0x801B3D8719AA28FAUL,0x0425D093CAFDCDF7UL,
    0x90E089D454F5BCCEUL,0x14DE64C087A259C3UL,
    0x1CA3BEE9210D93D9UL,0x989D53FDF25A76D4UL,
    0xB117E172CE4A94A6UL,0x35290C661D1D71ABUL,
    0x3D54D64FBBB2BBB1UL,0xB96A3B5B68E55EBCUL,
    0x2DAF621CF6ED2F85UL,0xA9918F0825BACA88UL,
    0xA1EC552183150092UL,0x25D2B8355042E59FUL,
    0x8B85A82006AEA64DUL,0x0FBB4534D5F94340UL,
    0x07C69F1D7356895AUL,0x83F87209A0016C57UL,
    0x173D2B4E3E091D6EUL,0x9303C65AED5EF863UL,
    0x9B7E1C734BF13279UL,0x1F40F16798A6D774UL,
    0x36CA43E8A4B63506UL,0xB2F4AEFC77E1D00BUL,
    0xBA8974D5D14E1A11UL,0x3EB799C10219FF1CUL,
    0xAA72C0869C118E25UL,0x2E4C2D924F466B28UL,
    0x2631F7BBE9E9A132UL,0xA20F1AAF3ABE443FUL,
    0x752492A591C865D6UL,0xF11A7FB1429F80DBUL,
    0xF967A598E4304AC1UL,0x7D59488C3767AFCCUL,
    0xE99C11CBA96FDEF5UL,0x6DA2FCDF7A383BF8UL,
    0x65DF26F6DC97F1E2UL,0xE1E1CBE20FC014EFUL,
    0xC86B796D33D0F69DUL,0x4C559479E0871390UL,
    0x44284E504628D98AUL,0xC016A344957F3C87UL,
    0x54D3FA030B774DBEUL,0xD0ED1717D820A8B3UL,
    0xD890CD3E7E8F62A9UL,0x5CAE202AADD887A4UL,
    0x61CC8D6B253E6DE1UL,0xE5F2607FF66988ECUL,
    0xED8FBA5650C642F6UL,0x69B157428391A7FBUL,
    0xFD740E051D99D6C2UL,0x794AE311CECE33CFUL,
    0x713739386861F9D5UL,0xF509D42CBB361CD8UL,
    0xDC8366A38726FEAAUL,0x58BD8BB754711BA7UL,
    0x50C0519EF2DED1BDUL,0xD4FEBC8A218934B0UL,
    0x403BE5CDBF814589UL,0xC40508D96CD6A084UL,
    0xCC78D2F0CA796A9EUL,0x48463FE4192E8F93UL,
    0x9F6DB7EEB258AE7AUL,0x1B535AFA610F4B77UL,
    0x132E80D3C7A0816DUL,0x97106DC714F76460UL,
    0x03D534808AFF1559UL,0x87EBD99459A8F054UL,
    0x8F9603BDFF073A4EUL,0x0BA8EEA92C50DF43UL,
    0x22225C2610403D31UL,0xA61CB132C317D83CUL,
    0xAE616B1B65B81226UL,0x2A5F860FB6EFF72BUL,
    0xBE9ADF4828E78612UL,0x3AA4325CFBB0631FUL,
    0x32D9E8755D1FA905UL,0xB6E705618E484C08UL,
    0x18B01574D8A40FDAUL,0x9C8EF8600BF3EAD7UL,
    0x94F32249AD5C20CDUL,0x10CDCF5D7E0BC5C0UL,
    0x8408961AE003B4F9UL,0x00367B0E335451F4UL,
    0x084BA12795FB9BEEUL,0x8C754C3346AC7EE3UL,
    0xA5FFFEBC7ABC9C91UL,0x21C113A8A9EB799CUL,
    0x29BCC9810F44B386UL,0xAD822495DC13568BUL,
    0x39477DD2421B27B2UL,0xBD7990C6914CC2BFUL,
    0xB5044AEF37E308A5UL,0x313AA7FBE4B4EDA8UL,
    0xE6112FF14FC2CC41UL,0x622FC2E59C95294CUL,
    0x6A5218CC3A3AE356UL,0xEE6CF5D8E96D065BUL,
    0x7AA9AC9F77657762UL,0xFE97418BA432926FUL,
    0xF6EA9BA2029D5875UL,0x72D476B6D1CABD78UL,
    0x5B5EC439EDDA5F0AUL,0xDF60292D3E8DBA07UL,
    0xD71DF3049822701DUL,0x53231E104B759510UL,
    0xC7E64757D57DE429UL,0x43D8AA43062A0124UL,
    0x4BA5706AA085CB3EUL,0xCF9B9D7E73D22E33UL,
    0x9335BD54DE0AA997UL,0x170B50400D5D4C9AUL,
    0x1F768A69ABF28680UL,0x9B48677D78A5638DUL,
    0x0F8D3E3AE6AD12B4UL,0x8BB3D32E35FAF7B9UL,
    0x83CE090793553DA3UL,0x07F0E4134002D8AEUL,
    0x2E7A569C7C123ADCUL,0xAA44BB88AF45DFD1UL,
    0xA23961A109EA15CBUL,0x26078CB5DABDF0C6UL,
    0xB2C2D5F244B581FFUL,0x36FC38E697E264F2UL,
    0x3E81E2CF314DAEE8UL,0xBABF0FDBE21A4BE5UL,
    0x6D9487D1496C6A0CUL,0xE9AA6AC59A3B8F01UL,
    0xE1D7B0EC3C94451BUL,0x65E95DF8EFC3A016UL,
    0xF12C04BF71CBD12FUL,0x7512E9ABA29C3422UL,
    0x7D6F33820433FE38UL,0xF951DE96D7641B35UL,
    0xD0DB6C19EB74F947UL,0x54E5810D38231C4AUL,
    0x5C985B249E8CD650UL,0xD8A6B6304DDB335DUL,
    0x4C63EF77D3D34264UL,0xC85D02630084A769UL,
    0xC020D84AA62B6D73UL,0x441E355E757C887EUL,
    0xEA49254B2390CBACUL,0x6E77C85FF0C72EA1UL,
    0x660A12765668E4BBUL,0xE234FF62853F01B6UL,
    0x76F1A6251B37708FUL,0xF2CF4B31C8609582UL,
    0xFAB291186ECF5F98UL,0x7E8C7C0CBD98BA95UL,
    0x5706CE83818858E7UL,0xD338239752DFBDEAUL,
    0xDB45F9BEF47077F0UL,0x5F7B14AA272792FDUL,
    0xCBBE4DEDB92FE3C4UL,0x4F80A0F96A7806C9UL,
    0x47FD7AD0CCD7CCD3UL,0xC3C397C41F8029DEUL,
    0x14E81FCEB4F60837UL,0x90D6F2DA67A1ED3AUL,
    0x98AB28F3C10E2720UL,0x1C95C5E71259C22DUL,
    0x88509CA08C51B314UL,0x0C6E71B45F065619UL,
    0x0413AB9DF9A99C03UL,0x802D46892AFE790EUL,
    0xA9A7F40616EE9B7CUL,0x2D991912C5B97E71UL,
    0x25E4C33B6316B46BUL,0xA1DA2E2FB0415166UL,
    0x351F77682E49205FUL,0xB1219A7CFD1EC552UL,
    0xB95C40555BB10F48UL,0x3D62AD4188E6EA45UL,
  };

}

